<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mastermind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html, body { height: 100%; }

      body {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        margin: 0;
        background-color: #444;
        font-size: 44px;
      }
      button, input {
        font-size: 27px;
      }
      @media (pointer: fine) {
        body {
          font-size: 20px;
        }
        button, input {
          font-size: 12px;
        }
      }
      svg {
        stroke: black;
        width: calc(1.3em * 4);
        height: 1.3em;
        vertical-align: middle;
      }
      hr { border-style: groove; }
      input { font-size: inherit; }
      button {
        vertical-align: middle;
        border: 1px solid black;
        border-radius: 3px;
      }
      input, button { vertical-align: inherit; }
      [title] { cursor: help; }

      .container {
        height: 100%;
        display: grid;
        grid-template:
          "instructions" auto
          "board" auto
          "controls" auto
          / auto;
      }
      @media (min-width: 700px) {
        .container {
          grid-template:
            "instructions board" 1fr
            "instructions controls" auto
            / 1fr 1fr 1fr;
        }
      }
      .instructions, .controls {
        color: #CCC;
        font-size: 20px;
      }
      .instructions {
        grid-area: instructions;
        align-self: center;
        margin: 0 5vw;
      }
      .board, .controls {
        justify-self: center;
      }
      .board {
        grid-area: board;
        box-sizing: border-box;
        display: inline-grid;
        justify-items: center;
        grid-template-rows: 1fr;
        margin: 1em 0;
        background-color: #966;
        padding: 1em;
        border-radius: 0.5em;
      }
      .controls {
        grid-area: controls;
        min-height: 16em;
      }

      .board table {
        border-spacing: 0;
        border: 1px solid rgba(0,0,0, 0.2);
      }
      td:first-child { width: 3.7em; }
      tbody td + td { width: 1em; }
      td + td, tfoot td { text-align: center; }
      tbody:not(:empty) + tfoot td { border-top: 2px solid rgba(0,0,0, 0.4); }

      .color-picker { position: relative; }
      .color-picker > svg:last-child {
        display: none;
        position: absolute;
        background-color: rgba(255,255,255, 0.4);
        outline: 1px solid black;
        border: 2px solid transparent;
        z-index: 1;
        top: 100%;
        width: calc(1.3em * 4);
        height: calc(1.3em * 6);
      }
      .color-picker:hover > svg:last-child { display: block; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="instructions">
        <h1>Mastermind</h1>
        <p>The object is to figure out the 4 colors in the secret answer.</p>
        <p>After you make a guess, you will be told the number of colors you have in the correct position "◼" and the number of colors in the wrong position "◻". These do not tell you which color is correct, that is for you to deduce.</p>
      </div>
      <div class="board">
        <table>
          <tbody data-ref="turns"></tbody>
          <tfoot data-ref="footer">
            <tr>
              <td><button data-ref="check">Check</button></td>
              <td colspan="4" class="color-picker" onclick="">
                <svg data-ref="pickedColors">
                  <use xlink:href="#circle" width="1.3em" height="1.3em" x="0%" y="0" fill="red" />
                  <use xlink:href="#circle" width="1.3em" height="1.3em" x="25%" y="0" fill="red" />
                  <use xlink:href="#circle" width="1.3em" height="1.3em" x="50%" y="0" fill="red" />
                  <use xlink:href="#circle" width="1.3em" height="1.3em" x="75%" y="0" fill="red" />
                </svg>
                <svg data-ref="colorPicker">
                  <g data-index="0">
                    <rect x="-1%" y="-1%" width="26%" height="17.666%" fill="#88E" stroke="none" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="0%" fill="red" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="16.666%" fill="green" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="33.333%" fill="blue" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="50%" fill="yellow" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="66.666%" fill="black" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="0%" y="83.333%" fill="white" />
                  </g>
                  <g data-index="1">
                    <rect x="24%" y="-1%" width="26%" height="17.666%" fill="#88E" stroke="none" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="0%" fill="red" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="16.666%" fill="green" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="33.333%" fill="blue" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="50%" fill="yellow" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="66.666%" fill="black" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="25%" y="83.333%" fill="white" />
                  </g>
                  <g data-index="2">
                    <rect x="49%" y="-1%" width="26%" height="17.666%" fill="#88E" stroke="none" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="0%" fill="red" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="16.666%" fill="green" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="33.333%" fill="blue" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="50%" fill="yellow" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="66.666%" fill="black" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="50%" y="83.333%" fill="white" />
                  </g>
                  <g data-index="3">
                    <rect x="74%" y="-1%" width="26%" height="17.666%" fill="#88E" stroke="none" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="0%" fill="red" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="16.666%" fill="green" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="33.333%" fill="blue" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="50%" fill="yellow" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="66.666%" fill="black" />
                    <use xlink:href="#circle" height="1.3em" width="1.3em" x="75%" y="83.333%" fill="white" />
                  </g>
                  <symbol id="circle">
                    <circle cx="50%" cy="50%" r="40%" />
                  </symbol>
                </svg>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="controls">
        <p>
          <span data-ref="duplicateMessage">Duplicate colors in answer</span>
          <label data-ref="duplicateLabel" for="duplicate" style="display:none">
            Duplicate colors in answer
          </label>
          <input type="checkbox" data-ref="duplicate" id="duplicate" checked />
        </p>
        <p data-ref="message"></p>
        <p>
          <button data-ref="newGame" style="display:none">give-up</button>
        </p>
      </div>
    </div>

    <script src="./index.js"></script>
    <script>
      class GameView {
        constructor(el) {
          this.el = el;
          this.refs = [...this.el.querySelectorAll('[data-ref]')].reduce((refs, el) => {
            refs[el.getAttribute('data-ref')] = el;
            return refs;
          }, {});
          this.refs.check.addEventListener('click', () => {
            if (!this.game) this.game = new MastermindGame(colors, this.refs.duplicate.checked);
            this.game.guess(this.pickedColors.slice());
            this.render();
          });
          this.refs.newGame.addEventListener('click', () => {
            const lastTurn = this.game.turns.slice(-1)[0];
            const won = lastTurn && lastTurn.matches === 4;
            if (won || this.giveUp) {
              this.newGame();
            } else {
              this.giveUp = true;
              this.render();
            }
          });
          this.refs.colorPicker.addEventListener('click', ({ target }) => {
            if (target.tagName !== 'use') return;
            const index = target.parentElement.dataset.index;
            const color = target.getAttribute('fill');
            this.pickedColors[index] = color;
            this.render();
          });
          this.newGame();
        }
        newGame() {
          this.game = null;
          this.refs.duplicateMessage.textContent = this.refs.duplicate.checked ? 'Duplicate colors in answer' : 'No duplicate colors in answer';
          this.pickedColors = ['red', 'red', 'red', 'red'];
          this.giveUp = false;
          this.render();
        }

        render() {
          const turns = this.game ? this.game.turns : [];
          const lastTurn = turns.slice(-1)[0];
          const won = lastTurn && lastTurn.matches === 4;
          const lastGuess = this.giveUp ? this.game.key : this.pickedColors;

          this.refs.check.style.display = this.giveUp ? 'none' : null;
          this.refs.turns.innerHTML = turns.map(this.renderTurn, this).join('');
          this.refs.footer.style.display = won || this.giveUp ? 'none' : null;
          this.refs.message.innerHTML = won
            ? `Won in ${turns.length} turns`
            : this.giveUp
            ? `Gave-up. Answer was <svg>${this.game.key.map((c,i) => `<use xlink:href="#circle" height="1.3em" width="1.3em" x="${25*i}%" y="0" fill="${c}" />`).join('')}</svg>`
            : '';
          this.refs.newGame.style.display = this.game ? null : 'none';
          this.refs.newGame.textContent = won || this.giveUp ? 'New Game' : 'give-up';
          this.refs.duplicateLabel.style.display =
          this.refs.duplicate.style.display = won || this.giveUp || !this.game ? null : 'none';
          this.refs.duplicateMessage.style.display = won || this.giveUp || !this.game ? 'none' : null;

          lastGuess.forEach((color, index) => {
            this.refs.colorPicker.querySelector(`g:nth-child(${index+1}) > rect`).setAttribute('y', colors.indexOf(color) * 100/6 - 1 + '%')
            this.refs.pickedColors.querySelectorAll('use')[index].setAttribute('fill', color);
          });
        }
        renderTurn({ guess, matches, misses }) {
          return `<tr>
            <td><span title="color in correct spot">${new Array(matches).fill('◼').join('')}</span><span title="color not in correct spot">${new Array(misses).fill('◻').join('')}</span></td>
            <td><svg>${guess.map((g, i) => `<use xlink:href="#circle" height="1.3em" width="1.3em" fill="${g}" x="${i*25}%" />`).join('')}</svg></td>
          </tr>`;
        }
      }

      const gameView = new GameView(document.querySelector('.container'));
    </script>
  </body>
</html>
