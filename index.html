<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mastermind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html, body { height: 100%; }

      body {
        display: grid;
        align-items: end;
        margin: 0;
        background-color: #444;
      }
      svg {
        width: 20px;
        height: 20px;
        stroke: black;
      }

      .board {
        display: inline-grid;
        grid-template-rows: 1fr;
        min-height: 23em;
        margin: 1em auto;
        background-color: #966;
        padding: 1em;
        border-radius: 0.5em;
      }

      .board table {
        border-spacing: 0;
        border: 1px solid rgba(0,0,0, 0.2);
      }
      td:first-child { width: 4.5em; }
      td + td, tfoot td { text-align: center; }
      tbody:not(:empty) + tfoot td { border-top: 2px solid rgba(0,0,0, 0.4); }
    </style>
  </head>
  <body>
    <div class="board"></div>

    <script>
      function firstOccurance(item, index, array) {
        return array.indexOf(item) === index;
      }
      function randInt(max) {
        return Math.floor(Math.random() * max);
      }

      class MastermindGame {
        static overlap(key=[], colors=[]) {
          const matches = key.filter((k, i) => colors[i] === k).length;
          const misses = colors.filter(firstOccurance).reduce(
            (count, color) =>
              count + Math.min(
                key.filter(k => k === color).length,
                colors.filter(c => c === color).length
              ),
            0
          ) - matches;

          return { matches, misses };
        }

        constructor(colors=['red', 'green', 'blue', 'yellow', 'black', 'white'], repeats=true) {
          const pool = colors.slice();

          this.key = repeats
            ? new Array(4).fill().map(() => pool[randInt(pool.length)])
            : new Array(4).fill().map(() => pool.splice(randInt(pool.length), 1)[0]);
          this.turns = [];
        }

        guess(colors=[]) {
          const { matches, misses } = this.constructor.overlap(this.key, colors);

          const turn = { guess: colors, matches, misses };
          this.turns.push(turn);
          return turn;
        }
      }

      const colors = ['red', 'green', 'blue', 'yellow', 'black', 'white'];
      class GameView {
        constructor(el) {
          this.el = el;
          this.el.innerHTML = `
            <table>
              <tbody data-ref="turns" />
              <tfoot data-ref="footer">
                <tr>
                  <td><button data-ref="check">Check</button></td>
                  <td><color-picker /></td>
                  <td><color-picker /></td>
                  <td><color-picker /></td>
                  <td><color-picker /></td>
                </tr>
              </tfoot>
            </table>
            <div>
              <span data-ref="message"></span>
              <button data-ref="newGame">give-up</button>
            </div>
          `;
          this.refs = [...this.el.querySelectorAll('[data-ref]')].reduce((refs, el) => {
            refs[el.getAttribute('data-ref')] = el;
            return refs;
          }, {});
          this.refs.check.addEventListener('click', (event) => {
            this.addGuess([...this.el.querySelectorAll('input')].map(e => e.value))
          });
          this.refs.newGame.addEventListener('click', (event) => {
            const lastTurn = this.game.turns.slice(-1)[0];
            const won = lastTurn && lastTurn.matches === 4;
            if (won || this.giveUp) {
              this.newGame();
            } else {
              this.giveUp = true;
              this.render();
            }
          });
          this.newGame();
        }
        newGame() {
          this.game = new MastermindGame(colors, true);
          this.giveUp = false;
          this.render();
        }
        addGuess(guess) {
          this.game.guess(guess);
          this.render();
        }

        render() {
          const { turns } = this.game
          const lastTurn = turns.slice(-1)[0];
          const won = lastTurn && lastTurn.matches === 4;
          const lastGuess = this.giveUp
            ? this.game.key
            : lastTurn
            ? lastTurn.guess : ['red', 'red', 'red', 'red'];

          this.refs.check.style.display = this.giveUp ? 'none' : null;
          this.refs.turns.innerHTML = turns.map(this.renderTurn, this).join('');
          this.refs.footer.style.display = won ? 'none' : null;
          this.refs.message.innerHTML = won
            ? `Won in ${turns.length} turns`
            : this.giveUp
            ? 'Gave-up'
            : '';
          this.refs.newGame.textContent = won || this.giveUp ? 'New Game' : 'give-up';

          this.el.querySelectorAll('color-picker').forEach((picker, index) => {
            picker.setAttribute('color', lastGuess[index]);
          });
        }
        renderTurn({ guess, matches, misses }) {
          return `<tr>
            <td>${new Array(matches).fill('◼').join('') + new Array(misses).fill('◻').join('')}</td>
            ${guess.map(g => `<td><svg width="20" height="20" fill="${g}"><circle cx="10" cy="10" r="8" /></svg></td>`).join('')}
          </tr>`;
        }
      }

      new GameView(document.querySelector('.board'));
    </script>

    <template id="color-picker">
      <style>
        color-picker {
          display: inline-block;
          position: relative;
          overflow: hidden;
          height: 20px;
          width: 20px;
        }
        color-picker:hover {
          overflow: visible;
        }
        color-picker > div {
          position: absolute;
        }
        color-picker:hover > div {
          background-color: rgba(255,255,255, 0.4);
          outline: 1px solid black;
          padding: 5px;
          z-index: 1;
          transform: translate(-5px, -5px);
        }
        color-picker > div > svg * {
          pointer-events: none;
        }
        color-picker[color="red"] > div { top: 1px; }
        color-picker[color="green"] > div { top: -23px; }
        color-picker[color="blue"] > div { top: -47px; }
        color-picker[color="yellow"] > div { top: -71px; }
        color-picker[color="black"] > div { top: -95px; }
        color-picker[color="white"] > div { top: -119px; }
      </style>
      <div>
        <svg width="20" height="20" fill="red"><circle cx="10" cy="10" r="8" /></svg>
        <svg width="20" height="20" fill="green"><circle cx="10" cy="10" r="8" /></svg>
        <svg width="20" height="20" fill="blue"><circle cx="10" cy="10" r="8" /></svg>
        <svg width="20" height="20" fill="yellow"><circle cx="10" cy="10" r="8" /></svg>
        <svg width="20" height="20" fill="black"><circle cx="10" cy="10" r="8" /></svg>
        <svg width="20" height="20" fill="white"><circle cx="10" cy="10" r="8" /></svg>
      </div>
      <input type="hidden" />
    </template>
    <script>
      class ColorPicker extends HTMLElement {
        static get observedAttributes() {
          return ["color"];
        }

        attributeChangedCallback(name, old, change) {
          if (name === 'color') this.input.value = change;
        }

        constructor() {
          super();
          const tpl = document.querySelector('template#color-picker');
          this.appendChild(tpl.content.cloneNode(true));
          this.input = this.querySelector('input');
        }

        connectedCallback() {
          this.setColor(this.getAttribute('color') || 'red');

          this.addEventListener('click', function(event) {
            if (event.target.tagName !== "svg") return;

            const color = event.target.getAttribute('fill');
            this.setColor(color);
          }, false);
        }

        setColor(color) {
          this.setAttribute('color', color);
          this.input.value = color;
        }
      }
      window.customElements.define('color-picker', ColorPicker);
    </script>
  </body>
</html>
