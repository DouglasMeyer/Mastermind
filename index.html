<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-126730436-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-126730436-1');
    </script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mastermind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html, body { height: 100%; }

      body {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        margin: 0;
        background-color: #444;
        font-size: 44px;
      }
      button, input {
        font-size: 27px;
      }
      @media (pointer: fine) {
        body {
          font-size: 20px;
        }
        button, input {
          font-size: 12px;
        }
      }
      svg {
        stroke: black;
        width: calc(1.3em * 4);
        height: 1.3em;
        vertical-align: middle;
      }
      hr { border-style: groove; }
      input { font-size: inherit; }
      button {
        vertical-align: middle;
        border: 1px solid black;
        border-radius: 3px;
      }
      input, button { vertical-align: inherit; }
      [title] { cursor: help; }

      .container {
        box-sizing: border-box;
        height: 100%;
        display: grid;
        grid-gap: 1em;
        grid-template:
          "instructions" auto
          "controls" auto
          "board" auto
          / auto;
      }
      @media (min-width: 700px) {
        .container {
          grid-template:
            "instructions controls" 4.6em
            "instructions board" 1fr
            / 1fr 1fr 1fr;
        }
      }
      .instructions, .controls {
        color: #CCC;
        font-size: 20px;
      }
      .instructions {
        grid-area: instructions;
        align-self: center;
        margin: 0 5vw;
      }
      .board, .controls {
        justify-self: center;
      }
      .board {
        grid-area: board;
        box-sizing: border-box;
        display: inline-grid;
        justify-items: center;
        grid-template-rows: 1fr;
        background-color: #966;
        padding: 1ex;
      }
      @media (min-width: 700px) {
        .board {
          margin: 0 1ex 1ex;
          border-radius: 0.5em;
        }
      }
      .controls {
        grid-area: controls;
        align-self: end;
        width: 15em;
      }

      .board table {
        border-spacing: 0;
      }
      td:first-child { width: 3.7em; }
      tbody td + td { width: 1em; }
      td + td, tfoot td { text-align: center; }

      .color-picker > svg:first-child {
        border: 1px solid black;
        border-bottom: 0;
      }
      .color-picker > svg:last-child {
        display: block;
        border: 1px solid black;
        width: calc(1.3em * 4);
        height: calc(1.3em * 6);
      }
    </style>
  </head>
  <body>
    <div class="container"></div>

    <script src="./index.js"></script>
    <script type="module">
      import { html, render, Component } from 'https://unpkg.com/htm/preact/standalone.mjs';

      class ColorsSelector extends Component {
        constructor(props) {
          super(props);
          this.handleClick = this.handleClick.bind(this);
        }
        handleClick({ target }) {
          if (target.tagName !== 'use') return;
          const value = this.props.value.slice();
          const index = target.parentElement.dataset.index;
          const color = target.getAttribute('fill');
          value[index] = color;
          this.props.onChange(value);
        }
        render({ colors, value }) {
          return html`<td colspan="4" class="color-picker" onclick="">
            <svg>
              ${value.map((color, index, arr) => html`<${Color} y="0" x=${`${100/arr.length*index}%`} color=${color} />`)}
            </svg>
            <svg onClick=${this.handleClick}>
              ${value.map((color, index) =>
                html`<g data-index=${index}>
                  <rect x=${`${25*index-1}%`} y=${`${colors.indexOf(color) * 100/6 - 1}%`} width="26%" height="17.666%" fill="#88E" stroke="none" />
                  ${colors.map((c,i) =>
                    html`<use xlink:href="#circle" height="1.3em" width="1.3em" x=${`${index*25}%`} y=${`${16.666*i}%`} fill=${c} />`
                  )}
                </g>`
              )}
              <symbol id="circle">
                <circle cx="50%" cy="50%" r="40%" />
              </symbol>
            </svg>
          </td>`;
        }
      }

      const Color = ({ color, ...props }) =>
        html`<use xlink:href="#circle" width="1.3em" height="1.3em" ...${props} fill="${color}" />`;

      const Turn = ({ guess, matches, misses }) => html`<tr>
        <td><span title="color in correct spot">${new Array(matches).fill('◼').join('')}</span><span title="color not in correct spot">${new Array(misses).fill('◻').join('')}</span></td>
        <td><svg>${guess.map((g, i, a) => html`<${Color} color="${g}" x="${`${100/a.length*i}%`}" />`)}</svg></td>
      </tr>`;

      class GameView extends Component {
        constructor(props) {
          super(props);
          this.handleCheck = this.handleCheck.bind(this);
          this.handleNewGame = this.handleNewGame.bind(this);
          this.handlePickColor = this.handlePickColor.bind(this);
          this.newGame();
        }
        newGame() {
          this.setState({
            game: null,
            pickedColors: ['red', 'red', 'red', 'red'],
            giveUp: false
          });
        }

        handleCheck() {
          const pickedColors = this.state.pickedColors.slice();
          if (this.state.game) {
            this.state.game.guess(pickedColors);
            this.forceUpdate();
          } else {
            const game = this.state.game || new MastermindGame(colors, this.duplicateEl.checked);
            game.guess(this.state.pickedColors.slice());
            this.setState({ game });
          }
        }
        handleNewGame() {
          const { game, giveUp } = this.state;
          const lastTurn = game.turns.slice(-1)[0];
          const won = lastTurn && lastTurn.matches === 4;
          if (won || giveUp) {
            this.newGame();
          } else {
            this.setState({ giveUp: true });
          }
        }
        handlePickColor(pickedColors) {
          this.setState({ pickedColors });
        }

        render({}, { game, pickedColors, giveUp }) {
          const turns = game ? game.turns : [];
          const lastTurn = turns.slice(-1)[0];
          const won = lastTurn && lastTurn.matches === 4;
          const lastGuess = giveUp ? game.key : pickedColors;

          return html`<div class="container">
            <div class="instructions">
              <h1>Mastermind</h1>
              <p>The object is to figure out the 4 colors in the secret answer.</p>
              <p>After you make a guess, you will be told the number of colors you have in the correct position "◼" and the number of colors in the wrong position "◻". These do not tell you which color is correct, that is for you to deduce.</p>
            </div>
            <div class="board">
              <table>
                <tbody>
                  ${turns.map(turn => html`<${Turn} ...${turn} />`)}
                </tbody>
                <tfoot style=${{ display: won || giveUp ? 'none' : null }}>
                  <tr>
                    <td><button style=${{ display: giveUp ? 'none' : null }} onClick=${this.handleCheck}>Check</button></td>
                    <${ColorsSelector} colors=${colors} value=${pickedColors} onChange=${this.handlePickColor} />
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="controls">
              <div>
                <span style=${{ display: won || giveUp || !game ? 'none' : null }}>
                  ${(game ? game.repeats : false) ? 'Duplicate colors in answer' : 'No duplicate colors in answer'}
                </span>
                <label for="duplicate" style=${{ display: won || giveUp || !game ? null : 'none' }}>
                  Duplicate colors in answer
                </label>
                <input type="checkbox" id="duplicate" ref=${el => this.duplicateEl = el} style=${{ display: won || giveUp || !game ? null : 'none' }} />
              </div>
              ${won
                ? html`<div>Won in ${turns.length} turns</div>`
                : giveUp
                ? html`<div>Gave-up. Answer was <svg>${game.key.map((c,i) => html`<${Color} x="${25*i}%" y="0" color="${c}" />`)}</svg></div>`
                : ''
              }
              <div>
                <button style=${{ display: game ? null : 'none' }} onClick=${this.handleNewGame}>
                  ${ won || giveUp ? 'New Game' : 'give-up' }
                </button>
              </div>
            </div>
          </div>`;
        }
      }
      render(html`<${GameView} />`, document.body);
    </script>
  </body>
</html>
